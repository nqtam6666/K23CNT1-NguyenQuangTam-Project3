<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Đặt phòng - ' + ${nqtWebsiteName ?: 'Hotel NQT'}">Đặt phòng - Hotel NQT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link th:with="fontName=${#strings.replace(nqtWebsiteFont ?: 'Inter', ' ', '+')}" 
          th:href="@{'https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=' + ${fontName} + ':wght@300;400;500;600;700&display=swap'}" 
          rel="stylesheet">
    <style th:inline="css">
        .font-serif { font-family: 'Playfair Display', serif; }
        * {
            font-family: /*[[${nqtWebsiteFont ?: 'Inter'}]]*/ 'Inter', sans-serif;
        }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .gold-accent { 
            color: /*[[${nqtWebsiteColor ?: '#d97706'}]]*/ #d97706;
        }
        .nav-glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); }
        :root {
            --color-primary: /*[[${nqtWebsiteColor ?: '#d97706'}]]*/ #d97706;
        }
        .input-focus:focus {
            outline: none;
            border-color: var(--color-primary);
            --tw-ring-color: var(--color-primary);
        }
        #btnCheckCode {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            min-width: 100px !important;
            height: auto !important;
            width: auto !important;
            position: relative !important;
            z-index: 10 !important;
        }
        .btn-submit {
            min-height: 48px;
            display: block;
            width: 100%;
        }
        .btn-submit:focus {
            outline: 2px solid var(--color-primary);
            outline-offset: 2px;
        }
        .service-card:hover {
            transform: translateY(-2px);
        }
        .service-card input[type="checkbox"]:checked ~ div {
            border-color: var(--color-primary);
            background-color: rgba(217, 119, 6, 0.05);
        }
        .service-card input[type="checkbox"]:checked {
            border-color: var(--color-primary);
        }
        .service-card.selected {
            border-color: var(--color-primary) !important;
            background-color: rgba(217, 119, 6, 0.05) !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-white">
    <nav class="nav-glass fixed top-0 left-0 right-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <a href="/nqtTrangChu" class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center shadow-lg overflow-hidden"
                        th:style="'background: linear-gradient(to bottom right, ' + ${nqtWebsiteColor ?: '#d97706'} + ', ' + ${#strings.replace(nqtWebsiteColor ?: '#d97706', '#', '')} + 'cc);'">
                        <img th:src="${nqtWebsiteLogo}" alt="Logo" class="w-full h-full object-cover"
                            th:if="${nqtWebsiteLogo != null and nqtWebsiteLogo != ''}">
                        <span class="text-white font-serif font-bold" 
                            th:unless="${nqtWebsiteLogo != null and nqtWebsiteLogo != ''}"
                            th:text="${#strings.substring(nqtWebsiteName ?: 'Hotel NQT', 0, 1)}">H</span>
                    </div>
                    <span class="text-xl font-serif font-bold text-gray-900" th:text="${nqtWebsiteName ?: 'Hotel NQT'}">Hotel NQT</span>
                </a>
                <a href="/nqtTrangChu" class="text-gray-700 hover:text-amber-700 transition-colors"
                   th:style="'color: ' + ${nqtWebsiteColor ?: '#d97706'} + ';'"
                   style="color: #d97706;">← Trang chủ</a>
            </div>
        </div>
    </nav>

    <div class="pt-20 pb-16">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center mb-8">
                <h1 class="font-serif text-4xl font-bold text-gray-900 mb-4">Đặt phòng <span class="gold-accent">của bạn</span></h1>
                <p class="text-gray-600">Hoàn tất thông tin để đặt phòng</p>
            </div>

            <!-- Error Message -->
            <div th:if="${nqtError}" class="mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-red-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                    <p class="text-red-700 font-medium" th:text="${nqtError}">Lỗi</p>
                </div>
            </div>

            <!-- Success Message -->
            <div th:if="${nqtSuccess}" class="mb-6 bg-green-50 border-l-4 border-green-500 p-4 rounded-lg">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <p class="text-green-700 font-medium" th:text="${nqtSuccess}">Thành công</p>
                </div>
            </div>

            <div class="glass-card rounded-2xl p-8 md:p-12">
                <form th:action="@{/nqtDatPhong}" method="post" class="space-y-6">
                    <div>
                        <label for="nqtPhongId" class="block text-sm font-medium text-gray-700 mb-2">Chọn phòng <span class="text-red-500">*</span></label>
                        <select id="nqtPhongId" name="nqtPhongId" required
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 input-focus">
                            <option value="">-- Chọn phòng --</option>
                            <option th:each="room : ${availableRooms}" th:value="${room.nqtId}" 
                                th:text="${room.nqtTenPhong} + ' - ' + ${room.nqtSoPhong} + ' (' + ${room.nqtLoaiPhong.nqtTenLoaiPhong} + ')'"
                                th:selected="${selectedPhongId != null and selectedPhongId == room.nqtId}">
                            </option>
                        </select>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label for="nqtNgayDen" class="block text-sm font-medium text-gray-700 mb-2">Ngày đến <span class="text-red-500">*</span></label>
                            <input type="date" id="nqtNgayDen" name="nqtNgayDen" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 input-focus"
                                th:value="${selectedNgayDen}">
                        </div>
                        <div>
                            <label for="nqtNgayDi" class="block text-sm font-medium text-gray-700 mb-2">Ngày đi <span class="text-red-500">*</span></label>
                            <input type="date" id="nqtNgayDi" name="nqtNgayDi" required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 input-focus"
                                th:value="${selectedNgayDi}">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Dịch vụ kèm theo (tùy chọn)</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3" th:if="${services != null and !services.isEmpty()}">
                            <div th:each="service : ${services}" 
                                th:id="'service-card-' + ${service.nqtId}"
                                class="service-card relative border-2 border-gray-200 rounded-lg p-4 hover:border-amber-400 transition-all duration-200 bg-white hover:shadow-md"
                                th:style="'border-color: ' + ${nqtWebsiteColor ?: '#d97706'} + '40;'">
                                <div class="flex items-start space-x-3">
                                    <input type="checkbox" th:id="'service-' + ${service.nqtId}" 
                                        th:name="nqtDichVuIds" th:value="${service.nqtId}"
                                        class="mt-1 w-5 h-5 border-gray-300 rounded service-checkbox flex-shrink-0 cursor-pointer"
                                        th:style="'accent-color: ' + ${nqtWebsiteColor ?: '#d97706'} + '; cursor: pointer;'"
                                        style="accent-color: #d97706; cursor: pointer;"
                                        onchange="toggleServiceCard(this);">
                                    <label th:for="'service-' + ${service.nqtId}" class="flex-1 min-w-0 cursor-pointer">
                                        <span class="block text-sm font-semibold text-gray-900"
                                            th:text="${service.nqtTen}">Dịch vụ</span>
                                        <p class="mt-1 text-sm font-medium"
                                            th:style="'color: ' + ${nqtWebsiteColor ?: '#d97706'} + ';'"
                                            style="color: #d97706;"
                                            th:text="${#numbers.formatDecimal(service.nqtDonGia, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">
                                            Giá
                                        </p>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 italic" th:if="${services == null or services.isEmpty()}">
                            Hiện tại không có dịch vụ nào khả dụng.
                        </p>
                    </div>

                    <div>
                        <label for="nqtMaGiamGia" class="block text-sm font-medium text-gray-700 mb-2">Mã giảm giá (tùy chọn)</label>
                        <div class="flex gap-2 items-center" style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="text" id="nqtMaGiamGia" name="nqtMaGiamGia"
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 input-focus text-gray-900 bg-white"
                                placeholder="Nhập mã giảm giá (VD: VIP10)"
                                style="flex: 1;">
                            <button type="button" id="btnCheckCode" 
                                style="padding: 0.75rem 1.5rem; background-color: #d97706; color: white; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; min-width: 100px; white-space: nowrap; flex-shrink: 0;"
                                th:style="'background-color: ' + ${nqtWebsiteColor ?: '#d97706'} + '; color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; border: none; min-width: 100px; white-space: nowrap; flex-shrink: 0;'"
                                onmouseover="this.style.backgroundColor='#b45309'"
                                onmouseout="this.style.backgroundColor='#d97706'">
                                Áp dụng
                            </button>
                        </div>
                        <p class="mt-1 text-xs text-gray-500" id="codeMessage"></p>
                        <div id="discountInfo" class="mt-2 hidden">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                                <p class="text-sm text-green-800">
                                    <span id="discountText"></span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="nqtGhiChu" class="block text-sm font-medium text-gray-700 mb-2">Ghi chú</label>
                        <textarea id="nqtGhiChu" name="nqtGhiChu" rows="4"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 input-focus"
                            placeholder="Ghi chú đặc biệt (nếu có)..."></textarea>
                    </div>

                    <button type="submit"
                        class="w-full text-white py-4 rounded-lg font-semibold hover:shadow-lg transition-all hover:scale-105 btn-submit"
                        th:style="'background: linear-gradient(to right, ' + ${nqtWebsiteColor ?: '#d97706'} + ', ' + ${#strings.replace(nqtWebsiteColor ?: '#d97706', '#', '')} + 'cc);'"
                        style="background: linear-gradient(to right, #d97706, #d97706cc);">
                        Xác nhận đặt phòng
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const primaryColor = /*[[${nqtWebsiteColor ?: '#d97706'}]]*/ '#d97706';
            const primaryColorDark = primaryColor + 'cc';
            
            // Apply color to button
            const submitButton = document.querySelector('.btn-submit');
            if (submitButton) {
                submitButton.style.background = 'linear-gradient(to right, ' + primaryColor + ', ' + primaryColorDark + ')';
            }
            
            // Apply focus color to inputs
            const inputs = document.querySelectorAll('.input-focus');
            inputs.forEach(function(input) {
                input.addEventListener('focus', function() {
                    this.style.borderColor = primaryColor;
                    this.style.boxShadow = '0 0 0 2px ' + primaryColor + '40';
                });
                input.addEventListener('blur', function() {
                    this.style.borderColor = '';
                    this.style.boxShadow = '';
                });
            });
            
            // Date validation and auto-fill from URL
            const today = new Date().toISOString().split('T')[0];
            const checkinInput = document.getElementById('nqtNgayDen');
            const checkoutInput = document.getElementById('nqtNgayDi');
            
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const ngayDen = urlParams.get('ngayDen');
            const ngayDi = urlParams.get('ngayDi');
            
            if (checkinInput) {
                checkinInput.setAttribute('min', today);
                // Set value from URL if available
                if (ngayDen) {
                    checkinInput.value = ngayDen;
                }
                checkinInput.addEventListener('change', function() {
                    if (checkoutInput) {
                        checkoutInput.setAttribute('min', this.value);
                    }
                });
            }
            
            if (checkoutInput) {
                checkoutInput.setAttribute('min', today);
                // Set value from URL if available
                if (ngayDi) {
                    checkoutInput.value = ngayDi;
                    // Also update min if checkin is set
                    if (checkinInput && checkinInput.value) {
                        checkoutInput.setAttribute('min', checkinInput.value);
                    }
                }
            }
            
            // Form validation before submit
            const bookingForm = document.querySelector('form[method="post"]');
            if (bookingForm) {
                bookingForm.addEventListener('submit', function(e) {
                    const checkin = checkinInput?.value;
                    const checkout = checkoutInput?.value;
                    
                    if (!checkin || !checkout) {
                        return; // Let HTML5 validation handle empty fields
                    }
                    
                    const checkinDate = new Date(checkin);
                    const checkoutDate = new Date(checkout);
                    
                    // Check if checkout is before or equal to checkin
                    if (checkoutDate <= checkinDate) {
                        e.preventDefault();
                        alert('Ngày đi phải sau ngày đến! Vui lòng chọn lại.');
                        if (checkoutInput) {
                            checkoutInput.focus();
                            checkoutInput.style.borderColor = '#ef4444';
                            setTimeout(() => {
                                checkoutInput.style.borderColor = '';
                            }, 3000);
                        }
                        return false;
                    }
                    
                    // Check if checkin is in the past
                    const todayDate = new Date();
                    todayDate.setHours(0, 0, 0, 0);
                    if (checkinDate < todayDate) {
                        e.preventDefault();
                        alert('Ngày đến không hợp lệ! Vui lòng chọn ngày từ hôm nay trở đi.');
                        if (checkinInput) {
                            checkinInput.focus();
                            checkinInput.style.borderColor = '#ef4444';
                            setTimeout(() => {
                                checkinInput.style.borderColor = '';
                            }, 3000);
                        }
                        return false;
                    }
                });
            }

            // Toggle service card style when checkbox is checked
            function toggleServiceCard(checkbox) {
                const card = checkbox.closest('.service-card');
                if (!card) return;
                
                const primaryColor = /*[[${nqtWebsiteColor ?: '#d97706'}]]*/ '#d97706';
                
                if (checkbox.checked) {
                    card.classList.add('selected');
                    card.style.borderColor = primaryColor;
                    card.style.backgroundColor = primaryColor + '0D'; // ~5% opacity
                } else {
                    card.classList.remove('selected');
                    card.style.borderColor = primaryColor + '40'; // ~25% opacity
                    card.style.backgroundColor = 'white';
                }
            }
            
            // Initialize service card states on page load
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelectorAll('.service-checkbox').forEach(function(checkbox) {
                    toggleServiceCard(checkbox);
                });
            });

            // Check discount code
            const btnCheckCode = document.getElementById('btnCheckCode');
            const codeInput = document.getElementById('nqtMaGiamGia');
            const codeMessage = document.getElementById('codeMessage');
            const discountInfo = document.getElementById('discountInfo');
            const discountText = document.getElementById('discountText');

            if (btnCheckCode && codeInput) {
                btnCheckCode.addEventListener('click', function() {
                    const code = codeInput.value.trim();
                    if (!code) {
                        codeMessage.textContent = 'Vui lòng nhập mã giảm giá';
                        codeMessage.className = 'mt-1 text-xs text-red-500';
                        discountInfo.classList.add('hidden');
                        return;
                    }

                    // Get estimated total price (simplified - you can improve this)
                    const roomSelect = document.getElementById('nqtPhongId');
                    const checkinDate = document.getElementById('nqtNgayDen').value;
                    const checkoutDate = document.getElementById('nqtNgayDi').value;
                    
                    // For now, just check the code without price validation
                    fetch('/api/check-discount-code?code=' + encodeURIComponent(code))
                        .then(response => response.json())
                        .then(data => {
                            if (data.valid) {
                                codeMessage.textContent = '✓ Mã giảm giá hợp lệ';
                                codeMessage.className = 'mt-1 text-xs text-green-600';
                                discountInfo.classList.remove('hidden');
                                discountText.textContent = data.message;
                            } else {
                                codeMessage.textContent = data.message || 'Mã giảm giá không hợp lệ';
                                codeMessage.className = 'mt-1 text-xs text-red-500';
                                discountInfo.classList.add('hidden');
                            }
                        })
                        .catch(error => {
                            codeMessage.textContent = 'Lỗi kiểm tra mã giảm giá';
                            codeMessage.className = 'mt-1 text-xs text-red-500';
                            discountInfo.classList.add('hidden');
                        });
                });
            }
        });
    </script>
</body>
</html>

